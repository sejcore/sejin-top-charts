<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <title>Sejin's Top Charts</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      :root { color-scheme: dark; }
      body { background:#000; }

      /* ===== Shared UI ===== */
      .stars { position: relative; display: inline-block; font-size: 18px; letter-spacing: 2px; }
      .stars .bg { color: #3f3f46; }
      .stars .fg { color: #FFD700; position: absolute; left: 0; top: 0; overflow: hidden; white-space: nowrap; } /* gold stars */
      .poster { width: 100%; aspect-ratio: 2/3; object-fit: cover; border-radius: 0.75rem; border:1px solid #262626; display:block; }
      .card { background: rgba(23,23,23,.6); backdrop-filter: blur(6px); border: 1px solid #262626; border-radius: 1rem; }
      .rank { font-size: 1.7rem; font-weight: 900; color: #FFD700; } /* gold rank */
      .flag-icon { width: 16px; height: 12px; object-fit: cover; display: inline-block; vertical-align: middle; }

      /* Wrap posters so we can glitch them with pseudo elements */
      .poster-wrap { position: relative; }
      .poster-wrap.glitch img {
        animation: imgGlitch 180ms steps(2) 1;
        filter: hue-rotate(180deg) saturate(160%) contrast(1.05);
      }
      .poster-wrap.glitch::after,
      .poster-wrap.glitch::before {
        content:"";
        position:absolute; inset:0; pointer-events:none;
      }
      /* Electric-blue scan slice */
      .poster-wrap.glitch::after{
        background:
          linear-gradient(to right, rgba(0,217,255,.85), rgba(0,217,255,0) 40%);
        mix-blend-mode: screen;
        opacity:.75;
        transform: translateY(-30%);
        clip-path: polygon(0% 40%, 100% 42%, 100% 58%, 0% 56%);
        animation: sliceGlitch 180ms ease-out 1;
        border-radius: 0.75rem;
      }
      /* Subtle scanline overlay */
      .poster-wrap.glitch::before{
        background: linear-gradient(to bottom, rgba(255,255,255,0) 0%,
                                    rgba(0,217,255,.25) 50%,
                                    rgba(255,255,255,0) 100%);
        mix-blend-mode: screen;
        opacity:.35;
        transform: translateY(-100%);
        animation: scanSweep 220ms linear 1;
        border-radius: 0.75rem;
      }

      @keyframes imgGlitch {
        0% { transform:none; }
        20% { transform: translate(-3px,1px) skewX(-3deg); }
        40% { transform: translate(3px,-1px) skewX(3deg); }
        60% { transform: translate(-2px,2px) skewX(-2deg); }
        80% { transform: translate(2px,-2px) skewX(2deg); }
        100% { transform:none; }
      }
      @keyframes sliceGlitch {
        0% { opacity:.0; transform: translateY(-50%); }
        25% { opacity:.85; transform: translateY(5%); }
        60% { opacity:.4; transform: translateY(50%); }
        100% { opacity:0; transform: translateY(120%); }
      }
      @keyframes scanSweep {
        from { transform: translateY(-110%); opacity:.25; }
        to   { transform: translateY(110%); opacity:.0; }
      }

      /* ===== Splash ===== */
      #splash {
        --bg:url('images/splash-hacker.jpg');
        position: fixed; inset: 0; width: 100%; height: 100%;
        background: #000 var(--bg) center/cover no-repeat;
        z-index: 50; display: flex; flex-direction: column;
        justify-content: center; align-items: center;
        text-align: center; padding: 2rem;
        font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue",
                     Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji", sans-serif;
      }
      #splash h1 {
        font-size: 2.2rem; /* smaller */
        text-shadow: 0 2px 12px rgba(0,0,0,.75);
      }
      #splash .disclaimer {
        max-width: 48rem;
        margin-top: 1.25rem;
        line-height: 1.6;
        color: rgba(243, 244, 246, .92);
        background: rgba(0,0,0,.48);
        border: 1px solid #1f2937;
        border-radius: 1rem;
        padding: 1.1rem 1rem;
        backdrop-filter: blur(6px);
        text-shadow: 0 0 10px rgba(0,0,0,.55);
        font-size: 1rem;
      }
      @media (max-width: 480px) {
        #splash .disclaimer { font-size: .9rem; }
        #enterBtn { font-size: 1.05rem; padding: .8rem 1.3rem; }
      }
      /* Electric blue ENTER */
      #enterBtn {
        background-color: #00d9ff;
        color: #001018;
        font-size: 1.35rem;
        font-weight: 800;
        padding: .95rem 1.4rem;
        border-radius: 9999px;
        text-transform: uppercase;
        box-shadow: 0 0 30px rgba(0,217,255,.8),
                    0 0 90px rgba(0,217,255,.5),
                    inset 0 0 10px rgba(255,255,255,.3);
        transition: transform .12s ease, box-shadow .2s ease, filter .2s ease;
        border: 1px solid rgba(0,217,255,.35);
      }
      #enterBtn:hover {
        transform: translateY(-1px) scale(1.02);
        box-shadow: 0 0 40px rgba(0,217,255,.95),
                    0 0 120px rgba(0,217,255,.6),
                    inset 0 0 14px rgba(255,255,255,.35);
        filter: brightness(1.05);
      }

      /* Glitch layers for splash (unchanged) */
      #splash .glitch-layer,
      #splash .glitch-scan,
      #splash .glitch-flash { position: absolute; inset: 0; pointer-events: none; }
      #splash .glitch-layer { background: var(--bg) center/cover no-repeat; mix-blend-mode: screen; opacity: 0; filter: saturate(120%) contrast(120%); }
      #splash .glitch-flash { background: radial-gradient(circle at 50% 50%, rgba(0, 217, 255, .22), transparent 60%); opacity: 0; }
      #splash.glitching .glitch-layer { animation: glitchShift 90ms steps(2) 0s 8 alternate, flicker 240ms linear 1; opacity: .55; }
      #splash.glitching .glitch-flash { animation: flashPop 260ms ease-out 1; opacity: .6; }
      #splash .glitch-scan {
        background: linear-gradient(to bottom, rgba(255,255,255,0) 0%, rgba(255,255,255,0.08) 50%, rgba(255,255,255,0) 100%);
        transform: translateY(-100%); opacity: 0; mix-blend-mode: screen;
      }
      #splash.glitching .glitch-scan { animation: scan 380ms linear 1; opacity: .35; }
      @keyframes glitchShift { 0%{transform:translate(0,0) skewX(0);filter:hue-rotate(0) contrast(120%)}25%{transform:translate(-10px,2px) skewX(-3deg)}50%{transform:translate(10px,-2px) skewX(3deg)}75%{transform:translate(-6px,3px) skewX(-2deg)}100%{transform:translate(0,0) skewX(0);filter:hue-rotate(-10deg) contrast(130%)} }
      @keyframes flicker { 0%,100% { opacity: .35; } 40% { opacity: .6; } 60% { opacity: .2; } }
      @keyframes scan { from { transform: translateY(-100%);} to { transform: translateY(100%);} }
      @keyframes flashPop { 0%{opacity:0;} 30%{opacity:.7;} 100%{opacity:0;} }

      /* Keep main content on solid black */
      #mainContent { position: relative; z-index: 1; background:#000; }
    </style>
  </head>
  <body class="min-h-screen text-white">
    <!-- ===== SPLASH ===== -->
    <section id="splash">
      <div class="glitch-layer" aria-hidden="true"></div>
      <div class="glitch-scan"  aria-hidden="true"></div>
      <div class="glitch-flash" aria-hidden="true"></div>

      <h1 class="text-4xl md:text-5xl font-black tracking-wide">Sejin's Top Charts</h1>

      <div class="disclaimer">
        <p><strong>Disclaimer:</strong> This is not medical, legal, culinary, romantic, investment, or life advice. Do your own research. The following selections, rankings, ratings, opinions, preferences, impulses, whims, hunches, and vibes are solely those of Sejin.</p>
      </div>

      <button id="enterBtn" class="mt-8">Enter</button>
    </section>

    <!-- ===== MAIN APP ===== -->
    <div id="mainContent" style="display:none;">
      <header class="max-w-6xl mx-auto px-4 py-8">
        <h1 class="text-3xl md:text-4xl font-bold tracking-wide text-center">Sejin's Top Charts</h1>
        <div class="mt-6 flex items-center justify-center gap-3">
          <label for="tabSelect" class="sr-only">Select chart</label>
          <select id="tabSelect" class="bg-neutral-900 text-white px-4 py-2 rounded-xl border border-neutral-800 outline-none">
            <option value="KR Movie">Korean Movies</option>
            <option value="KR Drama" selected>Korean Dramas</option>
            <option value="KR Music">Korean Music</option>
            <option value="EN Movie">American Movies</option>
            <option value="EN Drama">American Dramas</option>
            <option value="EN Music">American Music</option>
          </select>
          <span id="currentLabel" class="inline-flex items-center gap-2 bg-neutral-900/70 border border-neutral-800 rounded-xl px-3 py-1 text-sm text-neutral-300">
            <img src="images/kr-flag.png" alt="KR" class="flag-icon"/> Korean Dramas
          </span>
        </div>
      </header>

      <main class="max-w-6xl mx-auto px-4 pb-16">
        <div id="grid" class="grid gap-6 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4"></div>
        <div id="status" class="text-center text-neutral-400 mt-10"></div>
      </main>
    </div>

    <script>
      /* ===== Splash interactions + glitch scheduler ===== */
      const splash = document.getElementById('splash');
      const enterBtn = document.getElementById('enterBtn');
      const mainContent = document.getElementById('mainContent');

      function scheduleGlitch() {
        const wait = 1000 + Math.random() * 4000;
        setTimeout(() => {
          splash.classList.add('glitching');
          const duration = 500 + Math.random() * 700;
          setTimeout(() => {
            splash.classList.remove('glitching');
            scheduleGlitch();
          }, duration);
        }, wait);
      }
      scheduleGlitch();

      enterBtn.addEventListener('click', () => {
        splash.style.display = 'none';
        mainContent.style.display = 'block';
      });

      /* ===== Google Sheets setup ===== */
      const SHEET_ID = '1bUhsAN58vjTtDpRmbciDszWbgANzjuFDOyO48hH-Jwg';
      const API_KEY  = 'AIzaSyAnYfAfgCELD3iP9NCJMbCoJOCAbEyeUz0';
      const IMG_DIR  = 'images/';
      const PLACEHOLDER = IMG_DIR + 'placeholder.png';

      const TABS = [
        { key: 'KR Movie', label: '<img src="images/kr-flag.png" alt="KR" class="flag-icon"/> Movies' },
        { key: 'KR Drama', label: '<img src="images/kr-flag.png" alt="KR" class="flag-icon"/> Dramas' },
        { key: 'KR Music', label: '<img src="images/kr-flag.png" alt="KR" class="flag-icon"/> Music' },
        { key: 'EN Movie', label: '<img src="images/us-flag.png" alt="EN" class="flag-icon"/> Movies' },
        { key: 'EN Drama', label: '<img src="images/us-flag.png" alt="EN" class="flag-icon"/> Dramas' },
        { key: 'EN Music', label: '<img src="images/us-flag.png" alt="EN" class="flag-icon"/> Music' },
      ];

      const statusEl = document.getElementById('status');
      const gridEl = document.getElementById('grid');
      const tabSelect = document.getElementById('tabSelect');
      const currentLabel = document.getElementById('currentLabel');

      function starHTML(value) {
        const clamped = Math.max(0, Math.min(5, Number(value) || 0));
        const pct = (clamped / 5) * 100;
        const stars = '★★★★★';
        return `
          <span class="stars" aria-label="Rating ${clamped} of 5">
            <span class="bg">${stars}</span>
            <span class="fg" style="width:${pct}%">${stars}</span>
          </span>
          <span class="text-neutral-400 text-xs ml-2">${clamped.toFixed(1)}</span>
        `;
      }

      // Build image candidates for extension/casing mismatches
      function buildSrcCandidates(filename) {
        const safeName = (filename || '').trim();
        if (!safeName) return [];
        const enc = s => IMG_DIR + encodeURI(s);
        const m = safeName.match(/^(.*)\.([a-zA-Z0-9]+)$/);
        if (!m) return [enc(safeName)];
        const base = m[1], ext = m[2];
        const variantsByExt = {
          png:  ['png','PNG','jpg','JPG','jpeg','JPEG'],
          PNG:  ['PNG','png','JPG','jpg','JPEG','jpeg'],
          jpg:  ['jpg','JPG','png','PNG','jpeg','JPEG'],
          JPG:  ['JPG','jpg','PNG','png','JPEG','jpeg'],
          jpeg: ['jpeg','JPEG','jpg','JPG','png','PNG'],
          JPEG: ['JPEG','jpeg','JPG','jpg','PNG','png'],
        };
        const list = variantsByExt[ext] || [ext];
        return list.map(e => enc(`${base}.${e}`));
      }

      function handleImgErr(img) {
        const nextIndex = parseInt(img.dataset.errIndex || '0', 10) + 1;
        const candidates = (img.dataset.candidates || '').split('|').filter(Boolean);
        if (nextIndex < candidates.length) {
          img.dataset.errIndex = String(nextIndex);
          img.src = candidates[nextIndex];
        } else {
          img.onerror = null;
          img.src = PLACEHOLDER;
        }
      }

      function imgTagWithFallback(filename, title) {
        if (!filename) return `<img class="poster mb-3" src="${PLACEHOLDER}" alt="${title}"/>`;
        const candidates = buildSrcCandidates(filename);
        const primary = candidates[0] || PLACEHOLDER;
        const dataAttr = candidates.length ? `data-candidates="${candidates.join('|')}" data-err-index="0"` : '';
        const onerr = candidates.length ? 'onerror="handleImgErr(this)"' : '';
        return `<img class="poster mb-3" src="${primary}" alt="${title}" ${dataAttr} ${onerr}/>`;
      }

      function cardHTML(item) {
        const title = item.title || 'Untitled';
        const release = item.release || '';
        const producer = item.producer || '';
        return `
          <article class="card p-3">
            <div class="poster-wrap">
              ${imgTagWithFallback(item.image, title)}
            </div>
            <div class="flex items-start justify-between mt-3">
              <h3 class="text-base font-semibold leading-tight">${title}</h3>
              <span class="rank">#${item.rank || ''}</span>
            </div>
            ${release ? `<div class="text-xs font-semibold text-neutral-300 mt-1">${release}</div>` : ''}
            ${producer ? `<div class="text-xs font-semibold text-neutral-400">${producer}</div>` : ''}
            <div class="mt-2">${starHTML(item.rating)}</div>
          </article>
        `;
      }

      // Track timers so we can clear between tab switches
      let glitchTimers = [];

      function clearGlitchTimers() {
        glitchTimers.forEach(t => clearTimeout(t));
        glitchTimers = [];
      }

      function scheduleImageGlitches() {
        clearGlitchTimers();
        const wraps = gridEl.querySelectorAll('.poster-wrap');
        wraps.forEach(wrap => {
          const schedule = () => {
            const wait = 2000 + Math.random()*6000; // 2-8s random
            const t = setTimeout(() => {
              wrap.classList.add('glitch');
              setTimeout(() => {
                wrap.classList.remove('glitch');
                schedule();
              }, 220); // slightly longer than animation
            }, wait);
            glitchTimers.push(t);
          };
          schedule();
        });
      }

      async function loadTab(tabName) {
        statusEl.textContent = 'Loading…';
        gridEl.innerHTML = '';
        clearGlitchTimers();
        try {
          const url = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/'${encodeURIComponent(tabName)}'?key=${API_KEY}`;
          const res = await fetch(url);
          if (!res.ok) throw new Error('Data fetch ' + res.status);
          const json = await res.json();
          const rows = json.values || [];
          if (rows.length < 2) { statusEl.textContent = 'No data found.'; return; }
          const [, ...data] = rows;
          const items = data.map((r, i) => ({
            rank: r[0] ?? String(i+1),
            title: r[1] ?? '',
            release: r[2] ?? '',
            producer: r[3] ?? '',
            rating: parseFloat(r[4] ?? '0') || 0,
            image: (r[5] || '').trim()
          }));
          gridEl.innerHTML = items.map(cardHTML).join('');
          statusEl.textContent = '';
          scheduleImageGlitches(); // start per-image random glitches
        } catch (err) {
          console.error(err);
          statusEl.innerHTML = `<span class="text-red-400">Failed to load. Check sharing, key, and tab name.</span>`;
        }
      }

      tabSelect.addEventListener('change', () => {
        const tabName = tabSelect.value;
        const meta = TABS.find(t => t.key === tabName);
        currentLabel.innerHTML = (meta ? meta.label : tabName);
        loadTab(tabName);
      });

      // Default load
      loadTab('KR Drama');
    </script>
  </body>
</html>
